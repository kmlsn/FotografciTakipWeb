@{
    ViewBag.Title = "Ödemeler";
    Layout = "~/Areas/Musteri/Views/Shared/_Layout.cshtml";
    ViewBag.AdSoyad = Session["AdSoyad"];
    ViewBag.Email = Session["Email"];
    ViewBag.Firma = Session["Firma"];
    ViewBag.FirmaLogo = Session["FirmaLogo"];
}
@using FotografciTakipWeb.Models
@model List<Odemeler>

@section Head
{
    <style type="text/css">
        a {
            color: black;
        }
    </style>
}
<div class="modal fade" id="SozlesmeDetayModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header"><h4 class="modal-title" id="DetayBaslik">Sözleşme Detay Bilgileri</h4><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button></div><div class="modal-body">
                <div class="modal-body">
                    <table class="table">
                        <tr>
                            <td class="w-25"><b>Firma :</b></td>
                            <td id="FirmaAdi"></td>
                            <td class="w-25"><b>Firma Yetkilisi :</b></td>
                            <td id="YetkiliPersonel"></td>
                        </tr>
                        <tr>
                            <td class="w-25"><b>Sözleşme No :</b></td>
                            <td id="SozlesmeNo"></td>
                            <td class="w-25"><b>Rezervasyon Türü :</b></td>
                            <td id="RezervasyonTuru"></td>
                        </tr>
                        <tr>
                            <td class="w-25"><b>Sözleşme Tarihi :</b></td>
                            <td id="SozlesmeTarihi"></td>
                            <td class="w-25"><b>Saat :</b></td>
                            <td id="OrganizasyonSaati"></td>
                        </tr>
                        <tr>
                            <td class="w-25"><b>Opsiyon Tarihi :</b></td>
                            <td id="OpsiyonTarihi"></td>
                            <td class="w-25"><b>Görevli Personel :</b></td>
                            <td id="GorevliPersonel"></td>
                        </tr>
                        <tr>
                            <td class="w-25"><b>Müşteri :</b></td>
                            <td id="Musteri"></td>
                            <td class="w-25"><b>Müşteri Telefon :</b></td>
                            <td id="MusteriTelefon"></td>
                        </tr>
                        <tr id="OrganizasyonKimin"></tr>
                        <tr>
                            <td class="w-25"><b>Paketler :</b></td>
                            <td id="Paketler"></td>
                            <td class="w-25"><b>Ek Hizmetler :</b></td>
                            <td id="EkHizmetler"></td>
                        </tr>
                        <tr>
                            <td class="w-25"><b>Sözleşme Tutarı :</b></td>
                            <td id="SozlesmeTutari"></td>
                            <td class="w-25"><b>Durum :</b></td>
                            <td id="Durum"></td>
                        </tr>
                        <tr>
                            <td class="w-25"><b>Organizasyon Yeri :</b></td>
                            <td id="OrganizasyonYeri"></td>
                            <td class="w-25"><b>Notlar :</b></td>
                            <td id="Notlar"></td>
                        </tr>
                        @*<tr>
                                <td><b>İşlem :</b></td>
                                <td>
                                    <div class="d-flex mt-2">
                                        <a href="#" class="btn btn-sm btn-outline-danger mr-2" id="Sil2" title="Kaydı Sil" data-dismiss="modal"><i class="fal fa-times"></i> Sil</a>
                                        <a href="#" class="btn btn-sm btn-outline-primary mr-2" id="Duzenle2" title="Kaydı Düzenle"><i class="fal fa-edit"></i> Düzenle</a>
                                    </div>
                                </td>
                            </tr>*@
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-xl-12">
        <div id="panel-1" class="panel shadow-5">
            <div class="panel-hdr">
                <h2> Ödemelerim</h2>
                <input type="hidden" data-yetki="@ViewBag.MusteriYetkileri.OdemeMakbuzYazdir" id="makbuzyazdiryetki" />
            </div>
            <div class="panel-container show">
                <div class="panel-content">
                    <table id="tb-GelecekOdemeler" class="table table-bordered table-hover table-sm table-striped w-100">
                        <thead class="bg-primary-500">
                            <tr>
                                <th style="vertical-align:middle">İşlem Tarihi</th>
                                <th style="vertical-align:middle">Ödeme Tarihi</th>
                                <th style="vertical-align:middle">Sözleşme No</th>
                                <th style="vertical-align:middle">Ödeme Yapan</th>
                                <th style="vertical-align:middle">Ödeme Durumu</th>
                                <th style="vertical-align:middle">Tutar</th>
                                <th style="vertical-align:middle">Açıklama</th>
                                @if (ViewBag.MusteriYetkileri.OdemeMakbuzYazdir)
                                {
                                    <th style="vertical-align:middle" class="w-15">İşlem</th>
                                }
                                else
                                {
                                    <th style="vertical-align:middle; display:none" class="w-15">İşlem</th>
                                }
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    <!-- datatable end -->
                </div>
            </div>
        </div>
    </div>
</div>
@section Script
{
  
    <script>
        var dt;
        function ParaFormat(fiyat) {
            var para_sembol = "TL"
            var format = new Intl.NumberFormat('de-DE', {
                style: 'currency',
                currency: 'TRY',
                minumumFractionDigits: 2
            })
            //return format.format(fiyat)
            return format.format(fiyat).replace('TRY', para_sembol)
        }
        $(document).ready(function () {
            $("#tb-GelecekOdemeler").on('click', '.sozlesmedetay', function () {// Satıra ait "Düzenle" butonuna basıldığında düzenleme yapılacak modal penceresi açılarak gerekli bilgiler dolduruluyor.
                //document.getElementById("SozlesmeId").innerHTML = $(this).data("sozlesmeid");
                document.getElementById("SozlesmeNo").innerHTML = $(this).data("sozlesmeno");
                document.getElementById("FirmaAdi").innerHTML = $(this).data("firmaadi");
                document.getElementById("RezervasyonTuru").innerHTML = $(this).data("rezervasyontur");
                document.getElementById("YetkiliPersonel").innerHTML = $(this).data("yetkilipersonel");
                document.getElementById("SozlesmeTarihi").innerHTML = $(this).data("sozlesmetarih");
                var baslangic = $(this).data("baslangicsaat");
                var bitis = $(this).data("bitissaat");
                document.getElementById("OrganizasyonSaati").innerHTML = baslangic + " - " + bitis;
                if ($(this).data("opsiyontarihi") == "01.01.0001") {
                    document.getElementById("OpsiyonTarihi").innerHTML = "";
                }
                else {
                    document.getElementById("OpsiyonTarihi").innerHTML = $(this).data("opsiyontarihi");
                }
                //document.getElementById("OpsiyonTarihi").innerHTML = $(this).data("opsiyontarihi");
                document.getElementById("GorevliPersonel").innerHTML = $(this).data("gorevlipersonel");
                document.getElementById("Musteri").innerHTML = $(this).data("musteriadisoyadi");
                var musteritel = $(this).data("musteritelefon").replace(/(\d\d\d\d)(\d\d\d)(\d\d\d\d)/, "($1) $2 - $3");
                document.getElementById("MusteriTelefon").innerHTML = musteritel;
                if ($(this).data("yetkiliadsoyad") != null && ($(this).data("modeller") == null || $(this).data("urunler") == null)) {
                    $("#OrganizasyonKimin").empty();
                    $("#OrganizasyonKimin").append("<td class='w-25'><b>Organizasyon - Yetkili :</b></td>" +
                                                   "<td id='OrganizasyonYetkili'>" + $(this).data("yetkiliadsoyad") + "</td>" +
                                                   "<td class='w-25'><b>Organizasyon - Yetkili Tel/Email :</b> </td>" +
                                                   "<td id='OrganizasyonYetkiliTel'>" + $(this).data("yetkilitel") + " / " + $(this).data("yetkiliemail") + "</td>");
                }
                if ($(this).data("cocukadsoyad") != null) {
                    $("#OrganizasyonKimin").empty();
                    $("#OrganizasyonKimin").append("<td class='w-25'><b>Organizasyon - Cocuk Ad/Soyad :</b></td>" +
                                                   "<td id='OrganizasyonCocuk'>" + $(this).data("cocukadsoyad") + "</td>" +
                                                   "<td class='w-25'><b>Organizasyon - Anne/Baba :</b> </td>" +
                                                   "<td id='OrganizasyonAnneBaba'>" + $(this).data("annead") + " / " + $(this).data("babaad") + "</td>");
                }
                if ($(this).data("modeller") != null) {
                    $("#OrganizasyonKimin").empty();
                    $("#OrganizasyonKimin").append("<td class='w-25'><b>Organizasyon - Modeller :</b></td>" +
                                                   "<td id='OrganizasyonModeller'>" + $(this).data("modeller") + "</td>" +
                                                   "<td class='w-25'><b>Organizasyon - Yetkili :</b> </td>" +
                                                   "<td id='OrganizasyonModellerYetkili'>" + $(this).data("yetkiliadsoyad") + " / " + $(this).data("yetkilitel") + "</td>");
                }
                if ($(this).data("urunler") != null) {
                    $("#OrganizasyonKimin").empty();
                    $("#OrganizasyonKimin").append("<td class='w-25'><b>Organizasyon - Ürünler :</b></td>" +
                                                   "<td id='OrganizasyonUrunler'>" + $(this).data("urunler") + "</td>" +
                                                   "<td class='w-25'><b>Organizasyon - Yetkili :</b> </td>" +
                                                   "<td id='OrganizasyonUrunlerYetkili'>" + $(this).data("yetkiliadsoyad") + " / " + $(this).data("yetkilitel") + "</td>");
                }
                if ($(this).data("gelinad") != null || $(this).data("damatad") != null) {
                    $("#OrganizasyonKimin").empty();
                    $("#OrganizasyonKimin").append("<td class='w-25'><b>Gelin/Damat :</b></td>" +
                                                   "<td id='OrganizasyonGelinDamat'>" + $(this).data("gelinad") + " / " + $(this).data("damatad") + "</td>" +
                                                   "<td class='w-25'><b>Gelin/Damat Telefon :</b> </td>" +
                                                   "<td id='OrganizasyonGelinDamatTel'>" + $(this).data("gelintel") + " / " + $(this).data("damattel") + "</td>");
                }
                document.getElementById("Paketler").innerHTML = $(this).data("paketler");
                document.getElementById("EkHizmetler").innerHTML = $(this).data("ekhizmetler");
                document.getElementById("SozlesmeTutari").innerHTML = $(this).data("sozlesmetutar");
                if ($(this).data("bitti") == true) {
                    document.getElementById("Durum").innerHTML = $(this).data("durum") + " - Bitti";
                }
                else if ($(this).data("iptal") == true) {
                    document.getElementById("Durum").innerHTML = $(this).data("durum") + " - İptal";
                }
                else if ($(this).data("bitti") == false && $(this).data("iptal") == false) {
                    document.getElementById("Durum").innerHTML = $(this).data("durum");
                }
                document.getElementById("OrganizasyonYeri").innerHTML = $(this).data("organizasyonyeri");;
                document.getElementById("Notlar").innerHTML = $(this).data("notlar");
            });
            $("#tb-GelecekOdemeler").on('click', '.makbuzyazdir', function () {
                var id = $(this).data("odemeid");
                //window.location.replace("/Otomasyon/RezervasyonIslemleri/MakbuztoPDF/"+takipno);
                window.open("/Musteri/Dashboard/AlinanOdemeMakbuzYazdir/" + id, '_blank');
            });
            dt = $('#tb-GelecekOdemeler').dataTable(
               {
                   responsive: true,
                   "destroy": true,
                   "searching": false, // arama kaldır
                   "lengthChange": false, // sayfa başına göster kaldır
                   "createdRow": function (row, data, dataIndex) { // İptal edilmiş ise kırmızı, Ödeme alınmış ise Mavi
                       if (data["OdemeAl"] == true && data["OdemeTuru"] == "GelecekOdeme") {
                           //$(row).addClass('bg-warning-100 text-white');
                           $('td', row).addClass('bg-success-300 text-black');
                       }
                       if (data["OdemeAl"] == false && data["OdemeTuru"] == "GelecekOdeme") {
                           //$(row).addClass('bg-warning-100 text-white');
                           $('td', row).addClass('bg-warning-300 text-black');
                       }
                       if (data["OdemeAl"] == false && data["OdemeTuru"] == "AlinanOdeme") {
                           //$(row).addClass('bg-warning-100 text-white');
                           $('td', row).addClass('bg-success-300 text-black');
                       }
                       
                   },
                   "ordering": false,
                   "columns": [
                            { "data": "IslemTarihi", "autowidth": true, "className": "align-middle" }, // İşlem Tarihi
                            { "data": "OdemeTarihi", "autowidth": true, "className": "align-middle" }, // Ödeme Tarihi
                            { // Sözleşme No ; Sözleşme Detay
                                "data": null,
                                "autowidth": true,
                                "className": "align-middle",
                                "render": function (data, type, row) {
                                    ekhizmet = row.EkHizmetler.replace(/<span class='fw-700'>/g, "<span>");
                                    paket = row.Paketler.replace(/<span class='fw-700'>/g, "<span>");
                                    return "<a href='#' class='sozlesmedetay' title='Sözleşme Detayları' data-sozlesmeid='" + row.SozlesmeId + "' data-firmaadi='" + row.SozlesmeFirmaAdi + "' data-sozlesmeno='" + row.SozlesmeNo + "'" +
                                                     "data-sozlesmetarih='" + row.SozlesmeTarihi + "' data-opsiyontarihi='" + row.OpsiyonTarihi + "' data-rezervasyontur='" + row.RezervasyonTur + "' data-musteriadisoyadi='" + row.MusteriAdiSoyadi + "' data-musteritelefon='" + row.MusteriCepTel + "'" +
                                                     "data-yetkilipersonel='" + row.YetkiliPersonel + "' data-gorevlipersonel='" + row.GorevliPersonel + "' data-baslangicsaat='" + row.BaslangicSaat + "' data-bitissaat='" + row.BitisSaat + "' data-yetkiliadsoyad='" + row.YetkiliAdSoyad + "'" +
                                                     "data-yetkilitel='" + row.YetkiliTel + "' data-yetkiliemail='" + row.YetkiliEmail + "' data-annead='" + row.AnneAd + "' data-annetel='" + row.AnneTel + "' data=anneemail='" + row.AnneEmail + "' data-babaad='" + row.BabaAd + "'" +
                                                     "data-babatel='" + row.BabaTel + "' data-babaemail='" + row.BabaEmail + "' data-cocukadsoyad='" + row.CocukAdSoyad + "' data-modeller='" + row.Modeller + "' data-urunler='" + row.Urunler + "' data-gelinad='" + row.GelinAd + "'" +
                                                     "data-gelintel='" + row.GelinTel + "' data-gelinemail='" + row.GelinEmail + "' data-damatad='" + row.DamatAd + "' data-damattel='" + row.DamatTel + "' data-damatemail='" + row.DamatEmail + "' data-teklifbit='" + row.TeklifBit + "' data-paketler='" + paket + "'" +
                                                     "data-ekhizmetler='" + ekhizmet + "' data-paketlerfiyat='" + row.PaketlerFiyat + "' data-ekhizmetlerfiyat='" + row.EkHizmetlerFiyat + "' data-sozlesmetutar='" + row.SozlesmeTutar + "' data-organizasyonyeri='" + row.OrganizasyonYeri + "' data-notlar='" + row.SozlesmeNotlar + "'" +
                                                     "data-durum='" + row.Durum + "' data-bitti='" + row.Bitti + "' data-iptal='" + row.Iptal + "' data-toggle='modal' data-target='#SozlesmeDetayModal'>" +
                                                         row.SozlesmeNo +
                                                     "</a>"
                                }
                            },
                            { "data": "OdemeYapan", "autowidth": true, "className": "align-middle" },
                            {
                                "data": null, "autowidth": true,
                                "className": "align-middle",
                                "render": function (data, type, row) {
                                    if (row.OdemeTuru == "AlinanOdeme") {
                                        return "Ödendi";
                                    }
                                    else if (row.OdemeTuru == "GelecekOdeme") {
                                        return "Ödenecek";
                                    }
                                }
                            },
                            { // Tutar
                                "data": null,
                                "className": "align-middle",
                                "autowidth": true,
                                "render": function (data, type, row) {
                                    return ParaFormat(row.Tutar)
                                }
                            },
                            { "data": "Aciklama", "autowidth": true, "className": "align-middle" },
                            {
                                "data": null,
                                "className": "align-middle text-center",
                                "render": function (data, type, row) {
                                    islem = "";
                                    if ($("#makbuzyazdiryetki").data("yetki") == "True") {
                                        if (row.OdemeTuru == "AlinanOdeme") {
                                            if (row.OdemeIptal == false) {
                                                islem = islem + "<a type='button' class='btn btn-sm btn-secondary makbuzyazdir' style='color:white' data-odemeid='" + row.Id + "' data-makbuzno='" + row.AlinanOdemeMakbuzNo + "' data-alacaktarih='" + row.Tarih + "' data-alacaktutar='" + ParaFormat(row.Tutar) + "' data-alinanodemeid='" + row.AlinanOdemeId + "'>Makbuz Yazdır</a>"
                                            }
                                            else {
                                                islem = "İşlem yok!"
                                            }
                                        }
                                        else {
                                            islem = "İşlem yok!"
                                        }
                                    }
                                    else {
                                        islem="İşlem yok!"
                                    }
                                    return islem
                                }
                            }
                   ],
                   "processing": true,
                   "ajax": {
                       "url": "/Musteri/Dashboard/OdemelerListesi/",
                       "contentType": 'application/json; charset=utf-8',
                       'type': 'POST',
                       'data': function (data) { return data = JSON.stringify(data); }
                   },

                   "oLanguage": {
                       'sProcessing': 'Yükleniyor... Lütfen Bekleyin',
                       "sSearchPlaceholder": "Tabloda Ara",
                       "sZeroRecords": "Kayıt yok.",
                       "sLengthMenu": "Sayfa başına _MENU_ kayıt göster",
                       "sInfo": "_TOTAL_ kaydın _START_ ile _END_ arası gösteriliyor ",
                       "sInfoEmpty": "0 kaydın 0 ile 0 arası gösteriliyor",
                       "sInfoFiltered": "(_MAX_ toplam kayıttan filtrelendi)",
                       "oPaginate": {
                           "sPrevious": "Önceki",
                           "sNext": "Sonraki",
                           "sFirst": "İlk",
                           "sLast": "Son"
                       }
                   }
               });

        });
    </script>
}