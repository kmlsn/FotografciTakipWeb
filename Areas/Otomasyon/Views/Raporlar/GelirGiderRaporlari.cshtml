
@{
    ViewBag.Title = "Gelir-Gider Raporları";
    Layout = "~/Areas/Otomasyon/Views/Shared/_Layout.cshtml";
}
@section Head
{
    <style type="text/css">
        .c3-region.fff {
            fill: red;
        }
        .c3-region.foo {
            fill: green;
        }
    </style>
}
@using FotografciTakipWeb.Models
@model List<GelirGider>
@{
    var GelirGider = Model.GroupBy(c => c.Tarih.Month).Select(g => new
    {
        Ay = g.Key,
        Gelir = (g.Where(a => a.Tip == "Gelir").Sum(x => x.Tutar)),
        Gider = (g.Where(a => a.Tip == "Gider").Sum(x => x.Tutar)),
        Kazanç = (g.Where(a => a.Tip == "Gelir").Sum(x => x.Tutar) - g.Where(a => a.Tip == "Gider").Sum(x => x.Tutar))
    }).ToList();
    string[] aylar = { "OCAK", "ŞUBAT", "MART", "NİSAN", "MAYIS", "HAZİRAN", "TEMMUZ", "AĞUSTOS", "EYLÜL", "EKİM", "KASIM", "ARALIK" };
}
<!-- Gelir - Gider Tolapamları Satırı -->
<div class="row">
    <div class="col-sm-4 col-xl-3">
        <div class="p-3 bg-primary-500 rounded overflow-hidden position-relative text-white mb-g">
            <div class="">
                <h3 class="display-4 d-block l-h-n m-0 fw-500" id="GelirlerToplam">
                    @ViewBag.ToplamGelir.ToString("C").Replace("₺", "") TL
                    <small class="m-0 l-h-n">Toplam Gelir</small>
                </h3>
            </div>
            <i class="fal fa-plus-circle position-absolute pos-right pos-bottom opacity-15 mb-n1 mr-n1" style="font-size:6rem"></i>
        </div>
    </div>
    <div class="col-sm-4 col-xl-3">
        <div class="p-3 bg-warning-500 rounded overflow-hidden position-relative text-white mb-g">
            <div class="">
                <h3 class="display-4 d-block l-h-n m-0 fw-500" id="GiderlerToplam">
                    @ViewBag.ToplamGider.ToString("C").Replace("₺", "") TL
                    <small class="m-0 l-h-n">Toplam Gider</small>
                </h3>
            </div>
            <i class="fal fa-minus-circle position-absolute pos-right pos-bottom opacity-15  mb-n1 mr-n2" style="font-size: 6rem;"></i>
        </div>
    </div>
    <div class="col-sm-4 col-xl-3">
        <!-- alacak - borç  = sonuç (-) ise Kırmızı (bg-danger-200) olacak , (+) ise yeşil (bg-success-200) olacak, (0) ise gri (bg-fusion-50) olacak-->
        <div class="p-3 bg-success-800 rounded overflow-hidden position-relative text-white mb-g" id="BakiyeRenk">
            <div class="">
                <h3 class="display-4 d-block l-h-n m-0 fw-500" id="Kasa">
                    @ViewBag.Kazanc.ToString("C").Replace("₺", "") TL
                    <small class="m-0 l-h-n"><strong>Kazanç</strong></small>
                </h3>
            </div>
            <!-- alacak - borç  = sonuç (-) ise Simge sağa (<i class="fal fa-balance-scale-right"></i>) olacak , (+) ise simge sola(<i class="fal fa-balance-scale-left"></i>) olacak, (0) ise simge ortada (fal fa-balance-scale) olacak-->
            <i class="fal fa-balance-scale position-absolute pos-right pos-bottom opacity-15 mb-n0 mr-n0" id="BakiyeIkon" style="font-size: 6rem;"></i>
        </div>
    </div>

</div>
<!-- Gelir - Gider Tolapamları Satırı -->
<div class="col-xl-12">
    <div class="row">
        <div class="col-xl-6">
            <div id="panel-6" class="panel">
                <div class="panel-hdr">
                    <h2>
                        Aylık Gelir - Gider Raporu
                    </h2>
                </div>
                <div class="panel-container show">

                    <div class="panel-content">
                        <ul class="nav nav-tabs" role="tablist">
                            <li class="nav-item">
                                <a class="nav-link fs-lg px-4 active" data-toggle="tab" href="#gelir_gider_rapor_grafik" role="tab" aria-selected="true">
                                    <i class="fal fa-chart-area text-success"></i>
                                    <span class="hidden-sm-down ml-1">Grafik</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link fs-lg px-4" data-toggle="tab" href="#gelir_gider_rapor_tablo" role="tab" aria-selected="false">
                                    <i class="fal fa-table text-primary"></i>
                                    <span class="hidden-sm-down ml-1">Tablo</span>
                                </a>
                            </li>
                        </ul>
                        <div class="tab-content border border-top-0 p-3">
                            <div class="tab-pane fade active show" id="gelir_gider_rapor_grafik" role="tabpanel">
                                <div id="chart" style="width:100%; height:400px;"></div>
                            </div>
                            <div class="tab-pane fade" id="gelir_gider_rapor_tablo" role="tabpanel">
                                <table id="dt-basic-example" class="table table-bordered table-hover table-striped w-100">
                                    <thead class="bg-primary-600">
                                        <tr>
                                            <th>Aylar</th>
                                            <th>Gelir</th>
                                            <th>Gider</th>
                                            <th>Kazanç</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tablo-rapor">
                                        @foreach (var item in GelirGider)
                                        {
                                            string cls = "";
                                            cls = item.Kazanç > 0 ? "color-success-800" : "color-danger-800";
                                            <tr>
                                                <td>@aylar[item.Ay - 1]</td>
                                                <td>@item.Gelir.ToString("C").Replace("₺", "") TL</td>
                                                <td>@item.Gider.ToString("C").Replace("₺", "") TL</td>
                                                <td class="@cls">@item.Kazanç.ToString("C").Replace("₺", "") TL</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Script
{
    <script>
        function ParaFormat(fiyat) {
            var para_sembol = "TL"
            var format = new Intl.NumberFormat('de-DE', {
                style: 'currency',
                currency: 'TRY',
                minumumFractionDigits: 2
            })
            //return format.format(fiyat)
            return format.format(fiyat).replace('TRY', para_sembol)
        }
        $(document).ready(function () {
            var ay = [];
            $.ajax({
                type: "POST",
                url: "/Raporlar/GelirGiderRapor",
                data: {},
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (response) {
                    $.each(response, function (index, item) {
                        $.each(item, function (index, item_1) {
                            if (item_1.Ay == '1')
                            { ay.push("OCAK"); }
                            else if (item_1.Ay == '2')
                            { ay.push("ŞUBAT"); }
                            else if (item_1.Ay == '3')
                            { ay.push("MART"); }
                            else if (item_1.Ay == '4')
                            { ay.push("NİSAN"); }
                            else if (item_1.Ay == '5')
                            { ay.push("MAYIS"); }
                            else if (item_1.Ay == '6')
                            { ay.push("HAZİRAN"); }
                            else if (item_1.Ay == '7')
                            { ay.push("TEMMUZ"); }
                            else if (item_1.Ay == '8')
                            { ay.push("AĞUSTOS"); }
                            else if (item_1.Ay == '9')
                            { ay.push("EYLÜL"); }
                            else if (item_1.Ay == '10')
                            { ay.push("EKİM"); }
                            else if (item_1.Ay == '11')
                            { ay.push("KASIM"); }
                            else if (item_1.Ay == '12')
                            { ay.push("ARALIK"); }
                        });
                    });
                    var chart = c3.generate({
                        data: {
                            json: response.GelirGider,
                            keys: {
                                value: ['Gelir', 'Gider', 'Kazanç'],
                            },
                            columns: ['Gelir', 'Gider', 'Kazanç'],
                            colors: {
                                Gelir: '#5799C7',
                                Gider: '#FF9F4A',
                                Kazanç: '#2CA02C'
                                //#5799C7 Mavi (Gelir)
                                //#FF9F4A Turuncu (Gider)
                                //#2CA02C Yeşil ( + Kazanç)
                                //#FE3F3F Kırmızı ( - Kazanç)
                            },
                            color: function (color, d) {
                                // d will be 'id' when called for legends
                                return d.id === 'Kazanç' && d.value < 0 ? '#FE3F3F' : color;
                            },
                            types: {
                                Gelir: 'bar', Gider: 'bar', Kazanç: 'bar'
                            },
                            labels: {
                                format: function (d) { return accounting.formatMoney(d, "TL", 2, ".", ",", "%v %s") }
                            }
                        },
                        grid: {
                            //x: {
                            //    show: true
                            //},
                            y: {
                                show: true, lines: [{ value: 0 }]
                            }
                        },
                        bar: {
                            width: {
                                ratio: 0.7 // this makes bar width 50% of length between ticks
                            }
                            // or
                            //width: 100 // this makes bar width 100px
                        },
                        axis: {
                            x: {
                                type: 'category',
                                categories: ay
                                //categories: ['Ocak', 'Şubat', 'Mart', 'Nisan', 'Mayıs', 'Haziran', 'Temmuz', 'Ağustos', 'Eylül', 'Ekim', 'Kasım', 'Aralık']
                            },
                            y: {
                                //label: {
                                //    text: 'TL',
                                //    position: 'outer-center'
                                //    // inner-right : default
                                //    // inner-center
                                //    // inner-left
                                //    // outer-right
                                //    // outer-center
                                //    // outer-left
                                //    //#5799C7 MAvi
                                //    //#FF9F4A Turuncu
                                //    //#2CA02C Yeşil
                                //},
                                tick: {
                                    format: function (d) { return accounting.formatMoney(d, "TL", 2, ".", ",", "%v %s") }
                                }
                            }
                        },
                        regions: [
                            { start: 'Şubat', end: 'Mart', class: 'fff' },
                            { start: 'Nisan', end: 'Mayıs', class: 'foo' },
                            { start: 'Haziran', end: 'Temmuz', class: 'fff' },
                            { start: 'Ağustos', end: 'Eylül', class: 'foo' },
                            { start: 'Ekim', end: 'Kasım', class: 'fff' }
                        ],
                        tooltip: {
                            order: function (t1, t2, t3) {
                                return t1.id > t2.id > t3;
                            }
                        }
                    });
                },
            });

            $('#dt-basic-example').dataTable(
                    {
                        responsive: true,
                        lengthChange: false,
                        "searching": false, // arama kaldır
                        "lengthChange": false, // sayfa başına göster kaldır
                        "bPaginate": false,  // Sayfalamayı Kaldırır
                        //"bLengthChange": false,
                        //"bFilter": true,
                        "bInfo": false, // .. kayıtan 1 ile 5 arası yazısını kaldırır.
                        //"bAutoWidth": false,
                        "bSort": false, // sıralamayı kapatır
                        dom:
                            "<'row mb-3'<'col-sm-12 col-md-6 d-flex align-items-center justify-content-start'f><'col-sm-12 col-md-6 d-flex align-items-center justify-content-end'lB>>" +
                            "<'row'<'col-sm-12'tr>>" +
                            "<'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>",
                        buttons: [
                            //{
                            //    extend: 'pdfHtml5',
                            //    text: 'PDF',
                            //    titleAttr: 'Generate PDF',
                            //    className: 'btn-outline-danger btn-sm mr-1'
                            //},
                            {
                                extend: 'excelHtml5',
                                text: 'Excel',
                                titleAttr: 'Generate Excel',
                                className: 'btn-outline-success btn-sm mr-1'
                            }
                        ],
                        "lengthMenu": [[10, 25, 50, 100, -1], [10, 25, 50, 100, "Tümü"]],
                        "oLanguage": {
                            'sProcessing': 'Yükleniyor... Lütfen Bekleyin',
                            "sSearchPlaceholder": "Tabloda Ara",
                            "sZeroRecords": "Kayıt yok.",
                            "sLengthMenu": "Sayfa başına _MENU_ kayıt göster",
                            "sInfo": "_TOTAL_ kaydın _START_ ile _END_ arası gösteriliyor ",
                            "sInfoEmpty": "0 kaydın 0 ile 0 arası gösteriliyor",
                            "sInfoFiltered": "(_MAX_ toplam kayıttan filtrelendi)",
                            "oPaginate": {
                                "sPrevious": "Önceki",
                                "sNext": "Sonraki",
                                "sFirst": "İlk",
                                "sLast": "Son"
                            }
                        }
                    });

        });
    </script>
}