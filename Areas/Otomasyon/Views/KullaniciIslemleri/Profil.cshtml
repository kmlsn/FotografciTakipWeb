
@{
    ViewBag.Title = "Profil";
    Layout = "~/Areas/Otomasyon/Views/Shared/_Layout.cshtml";
}

@section Head
{
<link href="~/Areas/Otomasyon/Content/css/ResimYukle.css" rel="stylesheet" />
    <style>
        .modal {
            overflow: auto !important; /*Açılan ikinci modal ekranda kaymadığı için eklendi*/
        }
    </style>
}
@using FotografciTakipWeb.Models
@model Kullanici
<div class="modal fade" id="SifreDegistirModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header" style="padding-bottom:5px">
                <h4 class="modal-title">
                    Şifre Değiştir
                </h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true"><i class="fal fa-times"></i></span>
                </button>
            </div>
            <div class="modal-body">
                <div class="panel-content p-0">
                    <form action="#" autocomplete="off">
                        <div class="panel-content">
                            <div class="row mb-3">
                                <div class="form-group col-sm-12" id="EskiSifreHata">
                                    <label class="form-label" for="EskiSifre">Eski Şifreniz</label>
                                    <input type="password" id="EskiSifre" class="form-control" placeholder="Eski Şifreniz" required name="Sifre">
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="form-group col-sm-12" id="YeniSifreHata">
                                    <label class="form-label" for="YeniSifre">Yeni Şifreniz</label>
                                    <input type="password" id="YeniSifre" class="form-control" placeholder="Yeni Şifreniz" required name="Sifre">
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="form-group col-sm-12" id="YeniSifreTekrarHata">
                                    <label class="form-label" for="YeniSifreTekrar">Yeni Şifreniz(Tekrar)</label>
                                    <input type="password" id="YeniSifreTekrar" class="form-control" placeholder="Yeni Şifreniz(Tekrar)" required name="Sifre">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div class="modal-footer" style="padding-top:0px">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-primary" id="Kaydet">Kaydet</button>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="main-body">
        <div class="row gutters-sm">
            <div class="col-md-4 mb-3">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex flex-column align-items-center text-center">
                            <img src="@Model.Resim.ResimAdres" alt="Profil" class="rounded-circle" width="143"/>
                            <div class="mt-3">
                                <h4>@Model.AdSoyad</h4>
                                @*<p class="text-secondary mb-1">Full Stack Developer</p>
                                    <p class="text-muted font-size-sm">Bay Area, San Francisco, CA</p>*@
                                <button class="btn btn-primary" id="SifreDegistir" data-toggle='modal' data-target='#SifreDegistirModal'>Şifre Değiştir</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-sm-3">
                                <h6 class="mb-0">Ad-Soyad</h6>
                            </div>
                            <div class="col-sm-9 text-secondary">
                                @Model.AdSoyad
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-sm-3">
                                <h6 class="mb-0">Email</h6>
                            </div>
                            <div class="col-sm-9 text-secondary">
                                @Model.Email
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-sm-3">
                                <h6 class="mb-0">Telefon</h6>
                            </div>
                            <div class="col-sm-9 text-secondary">
                                @Model.CepTel
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-sm-3">
                                <h6 class="mb-0">Resim Değiştir</h6>
                            </div>
                            <div class="form-group col-sm-6">
                                <div id="image-preview-kullanici">
                                    <label for="image-upload" id="image-label">Resim Seç</label>
                                    <input type="file" name="Logo" id="image-upload" accept=".jpg, .jpeg, .png, .bmp, .tiff, .tif,|images/*" />
                                </div>
                            </div>
                            <div class="col-sm-3 align-self-center">
                                <button class="btn btn-primary" id="ResimDegistir">Resim Güncelle</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<input type="text" id="KullaniciId" class="form-control" name="Id" maxlength="50" style="display:none" value="@Model.Id">

@section Script
{
<script src="~/Areas/Otomasyon/Content/js/jquery.uploadPreview.min.js"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            $.uploadPreview({ // Resim Yükleme ile ilgili kodlar
                input_field: "#image-upload",   // Default: .image-upload  // Default: .image-upload
                preview_box: "#image-preview-kullanici",  // Default: .image-preview
                label_field: "#image-label",    // Default: .image-label
                label_default: "Resim Seç",   // Default: Choose File
                label_selected: "Resim Değiştir",  // Default: Change File
                no_label: false                 // Default: false
            }); // Resim Yükleme ile ilgili kodlar
            $('input').on('focusout', function (e) {
                if ($(this).val != "") {
                    $(this).next("div.hata").remove();
                }
            }); // Validation hata kaldırma
            $("#Kaydet").click(function () {
                var eskisifre = $("#EskiSifre").val();
                var yenisifre = $("#YeniSifre").val();
                var yenisifretekrar = $("#YeniSifreTekrar").val();
                console.log("EskiSifre: " + eskisifre);
                console.log("YeniSifre: " + yenisifre);
                console.log("YeniSifreTekrar: " + yenisifretekrar);
                if (eskisifre.length == 0) {
                    $("#EskiSifre").focus();
                    $("#EskiSifreHata").append("<div class='hata' style='color:red'>Eski şifrenizi giriniz.</div>");
                }
                else if (yenisifre.length == 0) {
                    $("#YeniSifre").focus();
                    $("#YeniSifreHata").append("<div class='hata' style='color:red'>Yeni şifrenizi giriniz.</div>");
                }
                else if (yenisifre.length < 6) {
                    $("#YeniSifre").focus();
                    $("#YeniSifreHata").append("<div class='hata' style='color:red'>Yeni şifrenizi en az 6 karakter olmalıdır.</div>");
                }
                else if (yenisifretekrar.length == 0) {
                    $("#YeniSifreTekrar").focus();
                    $("#YeniSifreTekrarHata").append("<div class='hata' style='color:red'>Yeni şifrenizi tekrar giriniz.</div>");
                }
                else if (yenisifre !== yenisifretekrar) {
                    $("#YeniSifreTekrar").focus();
                    $("#YeniSifreTekrarHata").append("<div class='hata' style='color:red'>Şifreler uyuşmuyor.</div>");
                }
                else
                {
                    var KullaniciData = new FormData();
                    KullaniciData.append("EskiSifre", eskisifre);
                    KullaniciData.append("YeniSifre", yenisifre);
                    KullaniciData.append("KullaniciId", $("#KullaniciId").val())
                    $.ajax({
                        type: "POST",
                        datatype: 'json',
                        data: KullaniciData,
                        contentType: false,
                        processData: false,
                        url: "/Otomasyon/KullaniciIslemleri/SifreDegistir",
                        success: function (data) { // Personel ile ilgili diğer tablolarda kayıt var ise silinemeyecek uyarı verecek.
                            if (data.Sonuc == false && data.Mesaj == "Eski şifre yanlış") {
                                $("#EskiSifre").focus();
                                $("#EskiSifreHata").append("<div class='hata' style='color:red'>Eski şifrenizi giriniz.</div>");
                            }
                            else if (data.Sonuc == false && data.Mesaj != "Eski şifre yanlış") {
                                $('#SifreDegistirModal').modal('hide');
                                alertify.set('notifier', 'delay', 5);
                                alertify.set('notifier', 'position', 'top-center');
                                alertify.error(data.Mesaj);
                            }
                            else if (data.Sonuc == true) {
                                $('#SifreDegistirModal').modal('hide');
                                alertify.set('notifier', 'delay', 5);
                                alertify.set('notifier', 'position', 'top-center');
                                alertify.success(data.Mesaj);
                            }
                        },
                        error: function (err) {
                            alert("HATA");
                        }
                    });
                }
            });
            $("#ResimDegistir").click(function () {
                var kullaniciresim = document.getElementById('image-upload');
                var ResimData = new FormData();
                for (i = 0; i < kullaniciresim.files.length; i++) {
                    //Appending each file to FormData object
                    ResimData.append(kullaniciresim.files[i].name, kullaniciresim.files[i]);
                }
                ResimData.append("KullaniciId", $("#KullaniciId").val())
                $.ajax({
                    type: "POST",
                    datatype: 'json',
                    data: ResimData,
                    contentType: false,
                    processData: false,
                    url: "/Otomasyon/KullaniciIslemleri/ResimDegistir",
                    success: function (data) { // Personel ile ilgili diğer tablolarda kayıt var ise silinemeyecek uyarı verecek.
                        if (data.Sonuc == true) {
                            window.location.replace("/Otomasyon/KullaniciIslemleri/Profil"); // aynı sekme
                        }
                    },
                    error: function (err) {
                        alert("HATA");
                    }
                });
            });
        });
    </script>

}

